# Common first steps on all nodes
#
- hosts: all
  tasks:
  - name: disable all repositories
    command: "yum-config-manager --disable '*'"
    ignore_errors: True
    when: disable_repos_first | default(False) | bool
    tags: subscribe

  - name: remove the RHUI client RPM
    package:
      name: rh-amazon-rhui-client
      state: absent
    tags: subscribe

  - name: subscribe to RHSM
    redhat_subscription:
      state: present
      username: "{{ rh_username }}"
      password: "{{ rh_password }}"
      force_register: True
    tags: subscribe

  - name: make sure RHSM repo management is enabled
    command: subscription-manager config --rhsm.manage_repos=1
    tags: subscribe

  - name: update packages
    package:
      name: '*'
      state: latest
      update_only: yes
    when: update | default(False) | bool
    tags: update

  - name: install the firewall
    package:
      name: iptables
      state: present
    tags: build_firewall

  - name: check if rebooting is needed
    command: needs-restarting -r
    register: needs_restarting
    failed_when: needs_restarting.rc not in [0, 1]
    tags: build_firewall

  - name: reboot after installing the firewall, if the kernel was updated at the same time
    reboot:
    when: needs_restarting.rc == 1
    tags: build_firewall

  - name: make sure the playbook package is installed on the clients
    package:
      name: rhc-worker-playbook
      state: latest
    when: inventory_hostname in groups['CLI']
    tags: rpm_install
