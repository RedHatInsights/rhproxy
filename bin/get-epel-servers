#!/usr/bin/env python3

import io
from datetime import datetime
from urllib.parse import urlparse

from lxml import etree

import requests


def get_hostname(mirror_name):
    url_parse = urlparse(mirror_name)
    return url_parse.hostname if url_parse.scheme else mirror_name


mirrors = set()
epel_repos = ["epel-5", "epel-6", "epel-7", "epel-8", "epel-9", "epel-10"]
archs = ["aarch64", "armhfp", "i386", "ppc64", "ppc64le", "s390", "s390x", "x86_64"]

for repo in epel_repos:
    for arch in archs:
        mirrors_url = (
            "https://mirrors.fedoraproject.org/metalink?repo={}&arch={}"
        ).format(repo, arch)
        mirrors_xml = requests.get(mirrors_url)
        mirrors_stream = io.BytesIO(mirrors_xml.content)
        for event, el in etree.iterparse(mirrors_stream):
            if el.tag == "{http://www.metalinker.org/}url":
                mirrors.add(get_hostname(el.text))

print("# Dnf/Yum EPEL Servers")
print("# Updated:       ", str(datetime.now().date()))
print("# Count:         ", len(mirrors))
print("# Versions:      ", ", ".join(epel_repos))
print("# Architectures: ", ", ".join(sorted(archs)))
print("#")
print("# Warning: Any updates to this file are lost when rhproxy is updated.")
print("\n".join(sorted(mirrors)))
exit(0)
